---
title: "Section_8_Team1_Lab2_Report"
author: "Jonas Degnan, Autumn Rains, Lucy Wu"
date: "8/5/2021"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---

```{r install packages, message=FALSE}
install.packages("table1")
install.packages("GGally")
install.packages("stargazer")
```

``` {r load packages, echo=FALSE}
#we may not need all of these
library(tidyverse)
library(magrittr)
library(ggplot2)
library(patchwork)
library(sandwich)
library(lmtest)
library(dplyr)
library(table1)
library(GGally)
library(stargazer)
theme_set(theme_minimal())
knitr::opts_chunk$set(echo = TRUE)
#knitr::knit(input = "./../notebooks/Draft_Report.Rmd", output = "./../reports/final_report.pdf")
```

## Introduction

Summer vacations in the United States are synonymous with sunny, leisurely days spent with loved ones. As Ella Fitzgerald so aptly sings, “Summertime, and the living is easy.” However, travel in the recent peak-vacation months has certainly deviated from this idealistic frame of mind with the onset of the COVID-19 pandemic in early 2020. The global travel industry has experienced sharp declines. Specifically in the United States, “travel spending totaled a mere $679 billion in 2020, an unprecedented 42% annual decline (nearly $500 billion) from 2019,” according to analysis from the U.S. Travel Association. 
As infection and vaccination rates oscillate regionally along with government policies for business operation restrictions in the United States, our team of data scientists will look to answer the following research question in more detail using linear regression techniques: 

Do COVID-19 infection rates impact vacation travel distance for U.S. residents in the state of Texas? 
Does income, population density, unemployment rates, and age in Texas counties impact traveling? 

We will analyze datasets from June, 2021 pertaining to these variables for Texas counties and create three models to understand if causal relationships exist between the number of long distance trips, population income, population density (rural or urban counties). Our hypothesis is that an there is a causal relationship between """

-->Need to explain distance of travel with bs TRANSPORT data
-->Need to add more to causal theory to justify variable selection

## Operationalization

To create our dataframe, we cleaned and filtered data from multiple sources of data and joined based on texas county name or code from June, 2021. 

#### Operationalization of focus variables
We gathered covid case and death data from NYT. We gathered trip distance data from the Bureau of Transportation, which they record based on data gathered from personal mobile devices. This data was presented as number of travelers in binned distances. We defined a short trip as less than 100 miles and long trips as greater than 100 miles. This was decided under the assumption that distances traveled of less than 100 miles are for the purpose of commuting, while greater than 100 miles indicated vacation travel. Hand in hand with this variable is our indicator variable for urban vs rural setting *** how did we decide this again, population threshold?**** under the assumption that those who live in rural settings are likely to commute further than those in an urban setting. Finally, we believe that median household income plays a significant role in an individual's ability to take vacations. We pulled this directly from the US Census Bureau. 

#### Operationalization of additional variables
To enrich our model and limit OVB, we brainstormed a number of additional variables that could affect travel rates during covid. For one, we looked at how covid affected the county, through the unemployment rate. We also looked at age, gender, income demographics. Then, in addition to income demographics, we focused on percent of younger folks, as defined as those younger than 17 and older folks as defined as those older than 65 because of the nature of how covid affects an individual.

### Variables

For our analysis, we will use datasets and variables from the four following sources:

[![DataSources](lab2datatable.JPG)](https://ibb.co/zQ3yj2K)

As indicated, each source will provide information on county population demographics such as income, rural vs. urban classification, and status of pandemic regulations. Together, these sources were filtered for the state of Texas and combined to create a dataframe for analysis.

```{r dataframe, echo=FALSE}
df <- read.csv('./../data/processed/covid_trips_processed.csv')
head(df)
```

## Exploratory Data Analysis

Table 1 below displays some information about the mean, median, minimum and maximum values for each variable. Figure 1 below depicts the distribution and correlation of each variable in our dataset by county type (where '0' indicates an urban county). From Figure 1, it can be observed that some of the variables are not distributed normally, are skewed,  and thus require transformations. More specifically, these variables are: Total Population, Total Cases, Total Deaths, Population Density. The outcome variable, Long Distance, will also require transformation. Upon further analysis, logarithmic transformations were chosen to normalize the distribution and minimize skewness. 

```{r EDA, echo=FALSE, message=FALSE}
#Example Table
df$rural_cat <- ifelse(df$is_rural == 1, "Rural", "Urban")
table1::label(df$density) <- "County Population Density"
table1::label(df$cases) <- "County Covid-19 Cases"
table1::label(df$unemployed) <- "County Unemployment Rate"
table1::label(df$median_income) <- "County Median Income ($)"
table1::label(df$lt17) <- "County Age < 17 years"
table1::label(df$gt65) <- "County Age > 65 years"
# table1::label(df$is_rural) <- "County Type"
table1::table1(~density + cases + unemployed + median_income + lt17 + gt65 | rural_cat, data = df, caption = "Table 1: Texas County Variable Statistics", topclass="Rtable1-zebra", overall = "Total")
```
Below are histograms of variables that did not follow normal distribution and required transformation. Each of these variables was logarithmically transformed.
```{r scatterplots, message=FALSE}
attach(df)
par(mfrow=c(3,2))
hist(cases, main="Histogram of Covid-19 Cases")
hist(deaths, main="Histogram of Covid-19 Deaths")
hist(long_trip, main="Histogram of Distance")
hist(density, main="Histogram of Population Density")
hist(unemployed, main="Histogram of Unemployment")
hist(median_income, main="Histogram of Median Income")

```


```{r ggally, echo=FALSE, message=FALSE}
County = as.factor(df$rural_cat)

df %>%
  mutate(
    cases = log(cases+1),
    deaths = log(deaths+1),
    long_trip = log(long_trip),
    density = log(density),
    median_income=log(median_income+1),
    unemployed = log(unemployed+1),
    lt17 = log(lt17),
    gt65 = log(gt65)
  ) %>%
  select(long_trip, cases, deaths, median_income, unemployed, density, lt17, gt65) %>%
  GGally::ggpairs(.,
               legend = 1,
               aes(color = County),
               title = "Figure 1: Variable Characterstics",
               upper = list(continuous = wrap("cor", size = 2.5)),
               lower = list(continuous = wrap("points", alpha = 0.5, size=0.3)),
               diag = list(continuous = wrap("densityDiag", alpha = 0.5)),
               columnLabels=c("Distance", "Cases", "Deaths", "Income", "Unemployment", "Pop Density", "Age < 17","Age > 65"))+
               theme(legend.position = "bottom")

# ggpairs(df, columns = 3:ncol(df), legend = 1, aes(color = County), title = "Figure 1: Variable Characterstics")
# #                upper = list(continuous = wrap("cor", size = 2.5)),
# #                lower = list(continuous = wrap("points", alpha = 0.5, size=0.3)),
# #                diag = list(continuous = wrap("densityDiag", alpha = 0.5)))

```


### Accounting Tables

To demonstrate the operationalization of the data, Tables 1 and 2 below display the original value counts from the dataset as well as how many values were removed as a part of filtering the dataset to remove all states except Texas. For the analysis, 230 responses were analyzed as shown in Table 1. Table 2 depicts the county type breakdown for rural or urban classification as well. 

```{r Accounting Table creation & output}
df2 <- df

df2$log_cases <-log10(df2$cases+1)
df2$log_deaths <-log10(df2$deaths+1)
df2$log_long_trip <-log10(df2$long_trip+1)
df2$log_density <- log10(df2$density+1)

#summary(df2)
df2 <- df2 %>% filter(!is.na(df2))

#df2 <- df2 %>% filter(!is.infinite(df2))

step_num = c(1,2)

number_of_samples = c(nrow(df),
                      nrow(df2))
samples_removed = c(0,
                    nrow(df)-nrow(df2))

                    
reasoning = c("Original Dataset",
              "Logarithmic Transformations")

accounting_df <- data.frame(step_num,
                            number_of_samples,
                            samples_removed,
                            reasoning)

colnames(accounting_df) <- c('Step','Number of Samples','Samples Removed', 'Reason')
knitr::kable(accounting_df, caption="Accounting Table", align = "c")

final_tab_df = dplyr::count(df2, rural_cat, sort = TRUE)
colnames(final_tab_df) <- c('County Type', 'Number of Samples')
knitr::kable(final_tab_df, caption="Table 2: Final Samples by County Type", align = "c")
```


#### Additional Changes to the Data:

Upon final review of the dataset, there are no additional changes required to prepare the dataset for data exploration and subsequent model creation. Outliers or incorrect data are not observed upon final inspection. The Accounting Table capture the changes made through cleaning and filtering as indicated previously. Table 2 above also displays the subset per county type for the overall dataset.

## A Model Building Process

To investigate the causal relationships between distance traveled and variables within the dataset, a linear regression was performed in R Studio for three models. The first model includes only our base variables. In the second model, we added additional county characteristics. In the final model, we added in another covid related factor.

Here is the first model, which is limited to study only key variables of interest for measurement based on our hypotheses. Our key input variable is covid cases and key output is number of trips greater than 100 miles. We also chose to add an indicator for rural counties because it could be directly related to trip distance
$$
  Model 1 = f(\text{log(#Long Trips)}) = \beta_0 + \beta_1 g(\text{log(Covid-19 Cases)}) + \beta_2 g(\text{log(Covid-19 Deaths)})  + \beta_3 h(\text{Rural County})
$$ 
The second model expands upon the first model to also include key explanatory variables and covariates that are hypothesized to improve performance of the previous model. Here, we added in median income and density of the county as additional descriptors of the county. 
$$
  Model 2 = f(\text{log(#Long Trips)}) = \beta_0 + \beta_1 g(\text{log(Covid-19 Cases)}) + \beta_2 g(\text{log(Covid-19 Deaths)})  + \beta_3 h(\text{Rural County}) + \beta_4 h(\text{Median Income}) + \beta_5 h(\text{County Density})
$$
Finally in the third model, we added in age demographics as percent under 17/over 65 as another potential source that influences travel midst covid cases due to the nature of how covid affects those at different ages.
$$
  Model 3 = f(\text{log(#Long Trips)}) = \beta_0 + \beta_1 g(\text{log(Covid-19 Cases)}) + \beta_2 g(\text{log(Covid-19 Deaths)})  + \beta_3 h(\text{Rural County}) + \beta_4 h(\text{Median Income}) + \beta_5 h(\text{County Density}) + \beta_6 h(\text{Population under 17}) + \beta_7 h(\text{Population over 65})
$$ 


## Linear Regression Results

The results from the linear regression analysis can be seen below for each model: 
```{r model creation, echo=FALSE, warning=FALSE}

#need to change these to per capita data
model1 <- lm(log(long_trip) ~ log(cases+1) + log(deaths+1) + is_rural, data = df) #limited model
model2 <- lm(log(long_trip) ~ log(cases+1) + log(deaths+1) + is_rural + log(median_income+1) + log(density), data = df)
model3 <- lm(log(long_trip) ~ log(cases+1) + log(deaths+1) + is_rural + log(median_income+1) + log(density) + log(lt17) + log(gt65), data = df) #final model
stargazer(model1, model2, model3, type='text', title="Results", align=TRUE)
```
From this output table, we can discern quite a bit of information. 

First, we consider the models holistically. Here are some of our observations:
* In model1, all of our variables are extremely significant, as expected from my hypotheses, though in the opposite direction. We would expect an inverse relationship between covid and travel, though it seems that this is estimating a positive relationship
* In model2, when county density is factored in, the presence of covid seems to have less positive of an effect on travel and that higher density counties see more travel. 
* In model3, with additionally age factored in, we see that actually the most statistically significant effect on long trips are median income of the household and presence of kids under 17. 
* In terms of R^2 and RSE, we are improving with each model. 
* The addition of our chosen parameters for each following model is also statistically better than the previous, as indicated by the F statistic. 

We will also interpret the coefficient values and what these mean in the context of our model. Almost all of our variables needed a log transform, including the output, making this a log-log regression. These regressions are most intuitive to understand in terms of percent increases. 
* First to note is our persistently significant constant in each model. Regardless of any variables, we are getting between ~300 (as with model3) and over 8000 (as with model2) trips over 100 miles. This is calculated as e^(Constant). 
* In model1, for every percent increase in both cases and deaths, we are getting almost half a percent increase in trips. The positive relationship doesnt make much sense, so we will look to the other models.
* In model2, we see that density has a more positive relationship with trips than do covid cases and deaths. 
* In model3, covid cases and deaths become insiginifcant, though its lookign 

Additionally, to indicate if any of the models provide a better fit to the dataset than a model that contains no independent variables, an F test was performed. The results for each model are shown below:
```{r F Test}
#Run F test to show statistical significance of additional variables
anova(model1, model2, model3, test = "F")
```
From the F-test,  we can see the the addition of the variables into model 2 and model 3 do contribute significant information to our model based off of the derived p-values.

Last, the significance of individual regression coefficients was tested using robust standard errors in R studio for model 3. The results are shown below: 
```{r coeftest}
#Run coeftest to show statistical significance of all variables in the model with robust standard errors
coeftest(model3, vcov = vcovHC(model3, type="HC1"))
```
From the t-test, we can see that Covid-19 cases and median income are statistically significant. Additionally, the percentage of adults greater than 65, the population density, and the Covid-19 death variables are even more statistically significant.

## Discussion

### Model Limitations

1. **IID Sampling:** There isn't a direct database check for this unfortunately. Looking into how the data was generated, we believe this is IID generally. The data was gathered from independent surveys within the Texas population for all models generated across all counties.

2. **No Perfect Colinearity:** This can be assessed through examination of the variance inflation factor (VIF). Running a VIF in R for model 2 and model 3, we see the VIF scores are relatively low (below 5) for the predictor variables. Therefore, no predictor variables were removed from the model. The results for the VIF analysis are seen in the table below:  

```{r VIF & correlation}

#create vector of VIF values
vif_values2 <- car::vif(model2)
vif_values2
vif_values3 <- car::vif(model3)
vif_values3

#Put values into nicer format table
```

3. **Linear Conditional Expectation:** For this assumption, the residuals for linear relationships must be evaluated. By plotting the residuals, as seen below in the first scatter plot for both model 2 and model 3 ('Residual vs Fitted'). We generally see a linear line as we move across predictor values with the residuals with no strong pattern. By transforming the variables as indicated previously logarithmically, we are able to see this linear relationship across all predictor values. 

4. **Homoskedastic Errors:** This assumption is examined by looking for constant error variance across the entire range of the x's (homoskedastic errors across the range of the x's). By plotting fitted values vs. the square root of the standardized residuals for the model 2 and model 3 ('Scale-Location' figure), there is an even or equal spread dispersion across the x values. Therefore model 2 and model both meet this condition when including the transformed variables.

5. **Normally Distributed Errors:** When investigating a normal distribution of the residuals, the QQ plot is helpful to investigate this assumption. For model 2 and model 3, a nice linear line can be seen between the theoretical quantities and the standardized residuals ('Normal Q-Q'). In conclusion, we meet this assumption with both model 2 and model 3.

```{r CLM assumptions check}

#run this to display the CLM graphs needed to verify CLM assumptions met
par(mfrow = c(2, 2))
plot(model2, col="blue") 
title("Model 2", line = -0.75, outer = TRUE)

# Model 3
# par(mfrow = c(2, 2))
# plot(model3, col="green") 
# title("Model 3", line = -0.75, outer = TRUE)

```

### Omitted Variable 

#### Variable 1

One example of an omitted variable that may cause bias in our model is that of vehicle ownership among the population. It can certainly be expected that individuals that own a vehicle would be able to more easily travel short or long distances more frequently with relative ease. If an individual owned a vehicle, this would influence our model by driving the bias further from zero. From the data available, there would no immediate proxy for this omitted variable.

#### Variable 2

Another example of an omitted variable that may also cause bias in our model is fuel prices. Whether this is jet fuel or gasoline, fluctuations in this commodity would certainly impact travel costs. If fuel prices increase, it is generally observed that costs for travel increase. The opposite is also generally true. In the instance of increased fuel prices, this would influence our model by driving the bias closer to zero as distance traveled would drop. Conversely, if fuel prices for the time period of the sample for the population were lower, the bias would would be farther from zero.

## Conclusion & Next Steps

The goal of this analysis was to determine if there existed a causal relationship between distance traveled and Covid-19 infection rates for residents of the state of Texas. Based upon the linear regression analysis above, model 2 would indicate there may be a causal relationship between distance traveled (outcome variable) and the variables found within that model. 

For future analysis, it is recommended that Covid-19 policy adherence data per county be incorporated into the model to increase the accuracy. While the Govenor of Texas issued detailed protocols or mandates for the state of Texas, the degree to which each county (and thus the individual residents) complied would be useful data to have if such data were to exist. Additionally, incorporating vaccination rates could aid in development of a model with even higher accuracy. Generally, vaccinations could increase confidence among individuals interested in traveling, especially if they have been in long periods of quarantine or government mandated lockdowns. Last, it is highly recommended that any model generated in the future continue to use the latest data available given the oscillation in vaccination rates, government policy, and new or known variants of the Covid-19 virus.

## References

