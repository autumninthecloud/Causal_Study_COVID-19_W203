
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r import libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
# source(local=TRUE, file="../util.R")
```

```{r read in data, echo=FALSE}
d_covid <- read.csv(url('https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv'))
d_openings <- read.csv(file = './../../data/raw/COVID-19 US state policy database (CUSP) - Closures & Reopening.csv')
d_trips <- read.csv(file = './../../data/raw/Trips_by_Distance.csv')
```

```{r filter parameters, echo=FALSE}
# state(s) under investigation
state_id = c("TX","Texas",48)

# dates under investigation
start_date = as.Date("2021-06-01")
end_date = as.Date("2021-06-30")

# start_date = as.Date("2021-06-01")
# end_date = as.Date("2021-06-30")
```


```{r clean covid data, echo=FALSE}
# COVID-19 data
# filters by date/state
d_covid <- d_covid %>%
  mutate(
    date = as.Date(date)
  ) %>%
  filter(
    (date >= start_date & date <= end_date),
    grepl(paste(state_id, collapse = "|"), state)
  )

# max county data (cases and deaths are cumulative)
d_covid <- d_covid %>%
  group_by(fips) %>%
  mutate(
    cases = max(cases) - min(cases),
    deaths = max(deaths) - min(cases),
    state = state.abb[match(state, state.name)]
  ) %>%
  select(
    county, state, fips, cases, deaths
  ) %>%
  distinct(fips, .keep_all = TRUE)
```

```{r clean mobility data, echo=FALSE}
# clean mobility data
 
# filters by date/state
d_trips <- d_trips %>%
  mutate(
    Date = as.Date(Date)
  ) %>%
  filter(
    (Date >= start_date & Date <= end_date),
    grepl(paste(state_id, collapse = "|"), State.Postal.Code)
  )
  
# cleaning
d_trips <- d_trips %>%
  # clean county name format
  mutate(
    County.Name = gsub("([A-Za-z]+).*", "\\1", County.Name),
    total_pop = select(.,Population.Staying.at.Home:Population.Not.Staying.at.Home) %>% rowSums(na.rm = TRUE)
    ) %>%
  group_by(County.FIPS) %>%
  mutate(
    # define long trips
    long_trip = sum(c_across(Number.of.Trips.100.250:Number.of.Trips...500)),
    long_trip_pc = long_trip/total_pop,
    # define short trips
    short_trip = sum(c_across(Number.of.Trips.1.3:Number.of.Trips.50.100)),
    short_trip_pc = short_trip/total_pop
  ) %>%
  rename(
    state = State.Postal.Code,
    county = County.Name,
    fips = County.FIPS
  ) %>%
  select(
    county, fips, state, total_pop, long_trip, long_trip_pc, short_trip, short_trip_pc
  ) %>%
  distinct(fips, .keep_all = TRUE)
```

```{r merged model_1 dataframe, echo=FALSE}
#code to merge county info to d
d <- merge(x = d_trips, y = d_covid, by = c("fips", "county", "state"))

#drop na and duplicates
d <- d %>% drop_na()
d <- unique(d)

#merge county policies to d
# d_openings$strict <- d_openings$Closed.bars.x2 != "0"

# d_openings$State.Postal.Code <- d_openings$State.Abbreviation
# d <- merge(x = d, y = d_openings[ , c("State.Postal.Code", "strict")], by = "State.Postal.Code", all.x = TRUE)
```


# Clean other variables
```{r read in variable data, echo=FALSE}
density <- read.delim("./../../data/raw/2019_Gaz_counties_national.txt", header=TRUE, sep="\t")
dp03_econ <- read.csv(file = './../../data/raw/ACSDP5Y2019.DP03_data_with_overlays_2021-07-26T143523.csv')
dp05_age <- read.csv(file = './../../data/raw/ACSDP1Y2019.DP05_data_with_overlays_2021-07-21T215013.csv')
s1901_income <- read.csv(file = './../../data/raw/ACSST1Y2019.S1901_data_with_overlays_2021-07-21T222906.csv') 
urb_rur_h2 <- read.csv(file = './../../data/raw/DECENNIALSF12010.H2_data_with_overlays_2021-06-08T173848.csv') 

```


```{r}
library(dplyr)
df = df %>% mutate(D=gsub("\\..*","",A))

              A    B   C    D
   awer.ttp.net Code 554 awer
   abcd.ttp.net Code 747 abcd
   asdf.ttp.net Part 554 asdf
    xyz.ttp.net Part 747  xyz
    
    names(df) <- substring(names(df), 4)
```


```{r clean dp03 data, echo=FALSE}
# filters by date/state
econ <- dp03_econ %>%
  rename(fips = GEO_ID, unemp_rate = DP03_0009PE) %>%
  select(fips, unemp_rate) %>%
  mutate(
    fips = substring(fips, 10)
  )

# merge into main dataframe
d <- merge(x = econ, y = d, by = c("fips"))
```


# Clean up
```{r remove interim dataframes}
# remove dataframes
rm(d_covid, d_trips, d_openings)
rm(dp03_econ, dp05_age, density, s1901_income, urb_rur_h2)

```

# Write to .csv
```{r export interim model_1 dataframe as csv, echo=FALSE}
write.csv(d, '../../data/interim/covid_trips_interim.csv')
```









