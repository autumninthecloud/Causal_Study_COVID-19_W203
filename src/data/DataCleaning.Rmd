---
title: "Lab2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r import libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(anytime)
# source(local=TRUE, file="../util.R")
```

```{r read in data, echo=FALSE}
d_covid <- read.csv(url('https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties-recent.csv'))
d_openings <- read.csv(file = './../../data/raw/COVID-19 US state policy database (CUSP) - Closures & Reopening.csv')
d_trips <- read.csv(file = './../../data/raw/Trips_by_Distance_-_2020.csv')

```

```{r filter parameters, echo=FALSE}
# state(s) under investigation
state_id = c("OH","Ohio",39)

# dates under investigation
start_date = as.Date("2021-06-01")
end_date = as.Date("2021-06-30")
```


```{r clean covid data, echo=FALSE}
# COVID-19 data
# filters by date/state
d_covid <- d_covid %>%
  mutate(
    date = as.Date(date)
  ) %>%
  filter(
    date >= start_date, date <= end_date,
    grepl(paste(state_id, collapse = "|"), state)
  )

# aggregate county data
d_covid <- d_covid %>%
  group_by(fips) %>%
  mutate(
    sum_cases = sum(cases),
    sum_deaths = sum(deaths),
    state = state.abb[match(state, state.name)]
  ) %>%
  select(
    county, state, fips, sum_cases, sum_deaths
  ) %>%
  distinct(fips, .keep_all = TRUE)
```

```{r clean mobility data, echo=FALSE}
# clean mobility data
 
# filters by date/state
d_trips <- d_trips %>%
  filter(d_trips, 
         Date >= "4/1/2020", Date <= "4/2/2020",
         grepl(paste(state_id, collapse = "|"), State.Postal.Code)
         )
  
# cleaning
d_trips_filter <- d_trips %>%
  
  mutate(County.Name = gsub("([A-Za-z]+).*", "\\1", County.Name)) %>%
  group_by(County.Name) %>%
  rowwise() %>%
  mutate(
    # clean county name format
    County.Name = gsub("([A-Za-z]+).*", "\\1", County.Name),
    # total pop
    total_pop = sum(c_across(Population.Staying.at.Home:Population.Not.Staying.at.Home)),
    # define long trips per capita
    long_trip = sum(c_across(Number.of.Trips.100.250:Number.of.Trips...500)),
    long_trips_pc = long_trip/total_pop,
    # # define short trips per capita
    short_trip = sum(c_across(Number.of.Trips.1.3:Number.of.Trips.50.100)),
    short_trips_pc = short_trip/total_pop
    # #
  ) %>%
  rename(
    state = State.Postal.Code,
    county = County.Name
  ) %>%
  select(
    county, state, total_pop, long_trip, long_trips_pc, short_trip, short_trips_pc
  ) %>%
  distinct(county, .keep_all = TRUE)
  
  # filter(State.Postal.Code %in% c(state[1])) 
  
  # filter(State.Postal.Code %in% c("AL"), grepl("Aut",County.Name)) 

trips_col <- ddply(d_trips, "County.Name", numcolwise(sum))

#clean county name format
trips_col$county <- gsub("([A-Za-z]+).*", "\\1", trips_col$County.Name)

#code to merge state info to d
d <- merge(x = trips_col, y = covid_col, by = "county")
d <- merge(x = d, y = d_trips[ , c("county", "State.Postal.Code")], by = "county", all.x=TRUE)

#merge county policies to d
d_openings$strict <- d_openings$Closed.bars.x2 != "0"

d_openings$State.Postal.Code <- d_openings$State.Abbreviation
d <- merge(x = d, y = d_openings[ , c("State.Postal.Code", "strict")], by = "State.Postal.Code", all.x = TRUE)

#drop na and duplicates
d <- d %>% drop_na()
d <- unique(d)
```


